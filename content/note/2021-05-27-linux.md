---
title: "Linux Cheat Sheet"
date: 2021-05-01T09:59:35+08:00
categories:
  - tech
---
## General
* zip/tar directory without compressing
```bash
zip -Z store -r  myfolder.zip myfolder
```

## Bash
Inside single quotes everything is preserved literally, without exception.

format date time
```bash
date=$(date '+%Y%m%d_%H%M%S')
```

extract value from file content, and use in shell script. 
```bash
SQL_TEXT="$(IFS=''; cat ~/dump/tbl1.sql)"
mysql -h 127.0.0.1 -e "${SQL_TEXT}"
```

get the directory in which a Bash script is located
```bash
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
```

package directory without compress
```bash
tar -cvf myfolder.tar myfolder
```

find .go file except the vendor directory
```bash
find . -path ./vendor -prune -false -o -name '*.go'`
```

find executable binary in a directory
```bash
find /usr/local/bin -type f -executable -exec sh -c 'test "$(head -c 2 "$1")" != "#!"' sh {} \; -print
```

grant access to directories recursively
```bash
find . -type d  -exec  chmod +x {} \;
```

find and grep
```bash
find . -name '*_test.go' -exec grep -Hn 127.0.0.1 {} \;

find . -name '*_test.go' -exec grep -Hn [golang.org/x](http://golang.org/x)  {}\;

find . -name '*.go' -exec grep --color -Hn "TODO:" {} \;

find . -name '*.[ch]' -exec grep --color -Hn 'struct page {' {} \;

grep "\.[ch]$" source_index.txt
```

list sub-directories by size
```bash
du -h --max-depth=1 | sort -h
```

decompress
```bash
# decompress filename.tar.xx
tar xvf archive.tar.xz
# GNU tar recognizes the format by itself!
```

find out binaries provided by a package.
```bash
dpkg -L mysql-community-server |grep -E '/s?bin/'
```

curl 100 times, and write the results line by line
```bash
for i in {1..100}; do curl -s http://34.69.165.177/; echo '' ;done > result.txt
```

directory checksum
```bash
find somedir -type f -exec md5sum {} \; | sort -k 2 | md5sum
```

field select using awk
```bash
$ netstat -anp |grep  chia |grep LISTEN |awk '{ print $7 }' |sort |uniq | awk 'BEGIN { FS = "/" } { print $2}'
chia_daemon
chia_wallet
chia_full_nod
chia_farmer
chia_harveste
```

Find the largest file in a directory and its subdirectories
```bash
find . -printf '%s %p\n'| sort -nr | head -10
```

disable bash history
```bash
## turn off bash history:
unset HISTFILE
#or
set +o history

## turn on bash history
set -o history
```

log and standard output
```bash
docker logs aaasdas9c356 > docker.log 2>&1

journalctl --since "2020-01-02 05:17"

## watch logs in directory
## ignored lines started with `==>` and empty lines
tail -f ./log | grep -v --line-buffered -e "^==> . <==$" | grep -v -e '^$'
```

copy to clipboard of X window
```bash
cat ~/.ssh/id_rsa.pub | xclip -selection c
```

reboot record
```
last reboot | less
```
sed
```bash
## parse environment variables
sed -z 's/$/\n/' /proc/4185/environ |grep -a GO
```
## git
```bash
# uncommitted changes since the last commit.
git diff

# diff staged changes.
git diff --cached

git diff HEAD
```

branch
```bash
## changes git remote branch follows
git branch branch_name --set-upstream-to origin/branch_name_b
git branch branch_name --set-upstream-to your_new_remote/branch_name
```

pull with proxy
```bash
export https_proxy=http://127.0.0.1:7890 http_proxy=http://127.0.0.1:7890 all_proxy=socks5://127.0.0.1:7890

git pull --recurse-submodules
```

pull submodules
```bash
## for the first time
git submodule update --init --recursive

## update
git pull --recurse-submodules
```

checkout github pr
```bash
# using gh
# https://github.com/mobile-shell/mosh/pull/1104

$ git clone https://github.com/mobile-shell/mosh
&& cd mosh
$ gh pr checkout 1104
$ ./autogen.sh && ./configure && make && sudo make install

# or, merge it manually
$ git remote add mgulick https://github.com/mgulick/mosh.git
$ git fetch mgulick osc-52-clipboard-types

# deps:
# sudo apt install pkg-config zlib1g-dev libssl-dev libncurses-dev libprotoc-dev protobuf-compiler libprotobuf-c-dev
# ./configure --prefix=/usr/local
```

git-fame: get repository contribution per author
```bash
pip3 install git-fame

tailscale git:(main) git-fame
Processing: 100%
Total commits: 2607
Total ctimes: 20339
Total files: 1227
Total loc: 91575
| Author                        |   loc |   coms |   fils |  distribution   |
|:------------------------------|------:|-------:|-------:|:----------------|
| Brad Fitzpatrick              | 41429 |   1279 |    314 | 45.2/49.1/25.6  |
| David Anderson                | 18233 |    546 |    206 | 19.9/20.9/16.8  |
| Earl Lee                      |  6848 |      2 |     85 | 7.5/ 0.1/ 6.9   |
| Josh Bleecher Snyder          |  5243 |    231 |    162 | 5.7/ 8.9/13.2   |
| David Crawshaw                |  3188 |    133 |     54 | 3.5/ 5.1/ 4.4   |
| Dmytro Shynkevych             |  3143 |     61 |     55 | 3.4/ 2.3/ 4.5   |
| Avery Pennarun                |  2921 |     95 |     63 | 3.2/ 3.6/ 5.1   |
| Christine Dodrill             |  1789 |     33 |     34 | 2.0/ 1.3/ 2.8   |
| Maisem Ali                    |  1641 |     14 |     39 | 1.8/ 0.5/ 3.2   |
| Denton Gentry                 |  1022 |     43 |     27 | 1.1/ 1.6/ 2.2   |

```

## Networking
### one line http file server in Python
```bash
$ python2 -m SimpleHTTPServer 8000
$ python3 -m http.server
```

### lsof
```bash
$ sudo lsof -nP -i4TCP:1080 -sTCP:LISTEN
$ sudo lsof -nP -i4TCP:1080 -sTCP:ESTABLISHED
$ sudo lsof -iTCP -sTCP:LISTEN -n -P

# -a means AND in lsof
$ sudo lsof -itcp -a -p "1280595"
```

### tcpdump
```bash
$ sudo tcpdump -i all host 127.0.0.1 and port 1080 -w cap1.pcap
```

### ip
```bash
# Bring wlan0 online
ip link set wlan0 up

# Bring wlan0 offline
ip link set wlan0 down
```

### iperf
```bash
# server
iperf3 -s

# client
iperf3 -c 192.168.2.1
```
### ssh tunnel
```bash
# listen on the remote side, and forward connection to the local side
ssh -p 22 -qngfNTR 8082:localhost:8080 dev2
```

## File system

mount local image file to file system

```bash
$ mount -o loop,offset=63963136 RetroPie_2017_8_29_rom.img /mnt/2

# find offset if multiple partition exists.
$ parted RetroPie_2017_8_29_rom.img
Disk /home/pi/RetroPie_2017_8_29_rom.img: 3276MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start   End     Size    Type     File system  Flags
 1      4194kB  64.0MB  59.8MB  primary  fat16        lba
 2      64.0MB  3275MB  3211MB  primary  ext4

(parted) u
Unit?  [compact]? B
(parted) print
Model:  (file)
Disk /home/pi/RetroPie_2017_8_29_rom.img: 3275999744B
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags:

Number  Start      End          Size         Type     File system  Flags
 1      4194304B   63963135B    59768832B    primary  fat16        lba
 2      63963136B  3274702847B  3210739712B  primary  ext4
```

## Package
### install with dependency
```
yum install ./percona-toolkit-3.3.1-1.el7.x86_64.rpm
```
### install libs

library missing error when compiling mosh

```bash
checking for protobuf... no
configure: error: Package requirements (protobuf) were not met:

No package 'protobuf' found

Consider adjusting the PKG_CONFIG_PATH environment variable if you
installed software in a non-standard prefix.

Alternatively, you may set the environment variables protobuf_CFLAGS
and protobuf_LIBS to avoid the need to call pkg-config.
See the pkg-config man page for more details.
```

search and install

```
sudo apt install pkg-config

sudo apt search protobuf
sudo apt install libprotobuf-dev
```
